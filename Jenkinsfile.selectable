pipeline {
    agent any

    parameters {
        // Main build scope selection
        choice(
            name: 'BUILD_SCOPE',
            choices: ['SELECT_INDIVIDUAL', 'ALL', 'ALL_BACKEND', 'ALL_FRONTEND'],
            description: 'Build scope: SELECT_INDIVIDUAL to pick specific services, or build ALL/ALL_BACKEND/ALL_FRONTEND'
        )

        // Individual Backend Services Selection
        booleanParam(name: 'BUILD_DISCOVERY_SERVICE', defaultValue: false, description: 'ðŸ” Build Discovery Service (Eureka)')
        booleanParam(name: 'BUILD_GATEWAY_SERVICE', defaultValue: false, description: 'ðŸšª Build Gateway Service')
        booleanParam(name: 'BUILD_AUTH_SERVICE', defaultValue: false, description: 'ðŸ” Build Auth Service')
        booleanParam(name: 'BUILD_PATIENT_SERVICE', defaultValue: false, description: 'ðŸ‘¤ Build Patient Service')
        booleanParam(name: 'BUILD_APPOINTMENT_SERVICE', defaultValue: false, description: 'ðŸ“… Build Appointment Service')
        booleanParam(name: 'BUILD_BILLING_SERVICE', defaultValue: false, description: 'ðŸ’° Build Billing Service')
        booleanParam(name: 'BUILD_PHARMACY_SERVICE', defaultValue: false, description: 'ðŸ’Š Build Pharmacy Service')

        // Frontend Selection
        booleanParam(name: 'BUILD_FRONTEND', defaultValue: false, description: 'ðŸŒ Build Frontend (Angular Portal)')

        // Deployment Options
        booleanParam(name: 'DEPLOY_TO_NEXUS', defaultValue: true, description: 'ðŸ“¦ Deploy artifacts to Nexus Maven Repository')
        booleanParam(name: 'DEPLOY_DOCKER_TO_NEXUS', defaultValue: true, description: 'ðŸ³ Deploy Docker images to Nexus Docker Registry')
        booleanParam(name: 'DEPLOY_TO_LOCAL_DOCKER', defaultValue: false, description: 'ðŸ–¥ï¸ Deploy to Local Docker (for testing)')
        booleanParam(name: 'RUN_TESTS', defaultValue: false, description: 'ðŸ§ª Run tests during build')
    }

    environment {
        JAVA_HOME = '/usr/lib/jvm/java-17-openjdk-amd64'
        PATH = "${JAVA_HOME}/bin:/usr/bin:${env.PATH}"
        GRADLE_OPTS = '-Dorg.gradle.daemon=false'

        // Nexus Configuration
        NEXUS_URL = 'http://localhost:8090'
        NEXUS_REPOSITORY = 'maven-releases'
        NEXUS_SNAPSHOT_REPOSITORY = 'maven-snapshots'
        NEXUS_CREDENTIALS_ID = 'nexus-credentials'

        // Docker Registry (Nexus Docker)
        DOCKER_REGISTRY = 'localhost:8091'
        DOCKER_CREDENTIALS_ID = 'nexus-docker-credentials'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'git@github.com:gopigopi096/ai_project_test.git', credentialsId: 'github-ssh-key'
                script {
                    env.GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD 2>/dev/null || echo "local"', returnStdout: true).trim()
                    env.BUILD_VERSION = "1.0.0-${env.GIT_COMMIT_SHORT}"
                    env.BUILD_TIMESTAMP = sh(script: 'date +%Y%m%d%H%M%S', returnStdout: true).trim()

                    // Determine which services to build based on scope and individual selections
                    env.BUILD_DISCOVERY = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_DISCOVERY_SERVICE) ? 'true' : 'false'
                    env.BUILD_GATEWAY = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_GATEWAY_SERVICE) ? 'true' : 'false'
                    env.BUILD_AUTH = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_AUTH_SERVICE) ? 'true' : 'false'
                    env.BUILD_PATIENT = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_PATIENT_SERVICE) ? 'true' : 'false'
                    env.BUILD_APPOINTMENT = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_APPOINTMENT_SERVICE) ? 'true' : 'false'
                    env.BUILD_BILLING = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_BILLING_SERVICE) ? 'true' : 'false'
                    env.BUILD_PHARMACY = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_BACKEND' || params.BUILD_PHARMACY_SERVICE) ? 'true' : 'false'
                    env.BUILD_FRONT = (params.BUILD_SCOPE == 'ALL' || params.BUILD_SCOPE == 'ALL_FRONTEND' || params.BUILD_FRONTEND) ? 'true' : 'false'

                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    IHMS BUILD CONFIGURATION                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Build Scope:    ${params.BUILD_SCOPE}
â•‘ Version:        ${env.BUILD_VERSION}
â•‘ Commit:         ${env.GIT_COMMIT_SHORT}
â•‘ Timestamp:      ${env.BUILD_TIMESTAMP}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ BACKEND SERVICES TO BUILD:                                               â•‘
â•‘   ðŸ” Discovery Service:   ${env.BUILD_DISCOVERY == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸšª Gateway Service:     ${env.BUILD_GATEWAY == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ” Auth Service:        ${env.BUILD_AUTH == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ‘¤ Patient Service:     ${env.BUILD_PATIENT == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ“… Appointment Service: ${env.BUILD_APPOINTMENT == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ’° Billing Service:     ${env.BUILD_BILLING == 'true' ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ’Š Pharmacy Service:    ${env.BUILD_PHARMACY == 'true' ? 'âœ… YES' : 'âŒ NO'}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ FRONTEND:                                                                â•‘
â•‘   ðŸŒ Angular Portal:      ${env.BUILD_FRONT == 'true' ? 'âœ… YES' : 'âŒ NO'}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ DEPLOYMENT OPTIONS:                                                      â•‘
â•‘   ðŸ“¦ Deploy to Nexus Maven:    ${params.DEPLOY_TO_NEXUS ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ³ Deploy Docker to Nexus:   ${params.DEPLOY_DOCKER_TO_NEXUS ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ–¥ï¸ Deploy to Local Docker:   ${params.DEPLOY_TO_LOCAL_DOCKER ? 'âœ… YES' : 'âŒ NO'}
â•‘   ðŸ§ª Run Tests:                ${params.RUN_TESTS ? 'âœ… YES' : 'âŒ NO'}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                }
            }
        }

        // ======================== BACKEND SERVICE BUILDS ========================

        stage('Build Common Library') {
            when {
                expression {
                    env.BUILD_DISCOVERY == 'true' || env.BUILD_GATEWAY == 'true' ||
                    env.BUILD_AUTH == 'true' || env.BUILD_PATIENT == 'true' ||
                    env.BUILD_APPOINTMENT == 'true' || env.BUILD_BILLING == 'true' ||
                    env.BUILD_PHARMACY == 'true'
                }
            }
            steps {
                echo 'ðŸ“š Building Common Library...'
                sh 'chmod +x gradlew'
                sh './gradlew :common-lib:clean :common-lib:build -x test --no-daemon'
            }
        }

        stage('Build Discovery Service') {
            when { expression { env.BUILD_DISCOVERY == 'true' } }
            steps {
                echo 'ðŸ” Building Discovery Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :discovery-service:clean :discovery-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Discovery Service build successful!'
                    archiveArtifacts artifacts: 'discovery-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Discovery Service build failed!' }
            }
        }

        stage('Build Gateway Service') {
            when { expression { env.BUILD_GATEWAY == 'true' } }
            steps {
                echo 'ðŸšª Building Gateway Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :gateway-service:clean :gateway-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Gateway Service build successful!'
                    archiveArtifacts artifacts: 'gateway-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Gateway Service build failed!' }
            }
        }

        stage('Build Auth Service') {
            when { expression { env.BUILD_AUTH == 'true' } }
            steps {
                echo 'ðŸ” Building Auth Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :auth-service:clean :auth-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Auth Service build successful!'
                    archiveArtifacts artifacts: 'auth-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Auth Service build failed!' }
            }
        }

        stage('Build Patient Service') {
            when { expression { env.BUILD_PATIENT == 'true' } }
            steps {
                echo 'ðŸ‘¤ Building Patient Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :patient-service:clean :patient-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Patient Service build successful!'
                    archiveArtifacts artifacts: 'patient-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Patient Service build failed!' }
            }
        }

        stage('Build Appointment Service') {
            when { expression { env.BUILD_APPOINTMENT == 'true' } }
            steps {
                echo 'ðŸ“… Building Appointment Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :appointment-service:clean :appointment-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Appointment Service build successful!'
                    archiveArtifacts artifacts: 'appointment-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Appointment Service build failed!' }
            }
        }

        stage('Build Billing Service') {
            when { expression { env.BUILD_BILLING == 'true' } }
            steps {
                echo 'ðŸ’° Building Billing Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :billing-service:clean :billing-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Billing Service build successful!'
                    archiveArtifacts artifacts: 'billing-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Billing Service build failed!' }
            }
        }

        stage('Build Pharmacy Service') {
            when { expression { env.BUILD_PHARMACY == 'true' } }
            steps {
                echo 'ðŸ’Š Building Pharmacy Service...'
                script {
                    def testFlag = params.RUN_TESTS ? '' : '-x test'
                    sh "./gradlew :pharmacy-service:clean :pharmacy-service:build ${testFlag} --no-daemon"
                }
            }
            post {
                success {
                    echo 'âœ… Pharmacy Service build successful!'
                    archiveArtifacts artifacts: 'pharmacy-service/build/libs/*-SNAPSHOT.jar', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Pharmacy Service build failed!' }
            }
        }

        // ======================== FRONTEND BUILD ========================

        stage('Build Frontend') {
            when { expression { env.BUILD_FRONT == 'true' } }
            steps {
                echo 'ðŸŒ Building Frontend (Angular)...'
                dir('frontend/ihms-portal') {
                    sh '/usr/bin/node /usr/lib/node_modules/npm/bin/npm-cli.js ci'
                    sh '/usr/bin/node node_modules/.bin/ng build --configuration=production'
                }
            }
            post {
                success {
                    echo 'âœ… Frontend build successful!'
                    // Create tarball for Nexus deployment
                    sh 'cd frontend/ihms-portal/dist/ihms-portal/browser && tar -czvf ../../../../ihms-portal-${BUILD_VERSION}.tar.gz .'
                    archiveArtifacts artifacts: 'frontend/ihms-portal-*.tar.gz', fingerprint: true, allowEmptyArchive: true
                }
                failure { echo 'âŒ Frontend build failed!' }
            }
        }

        // ======================== DEPLOY TO NEXUS MAVEN REPOSITORY ========================

        stage('Deploy JARs to Nexus Maven') {
            when {
                allOf {
                    expression { params.DEPLOY_TO_NEXUS == true }
                    expression {
                        env.BUILD_DISCOVERY == 'true' || env.BUILD_GATEWAY == 'true' ||
                        env.BUILD_AUTH == 'true' || env.BUILD_PATIENT == 'true' ||
                        env.BUILD_APPOINTMENT == 'true' || env.BUILD_BILLING == 'true' ||
                        env.BUILD_PHARMACY == 'true'
                    }
                }
            }
            steps {
                echo 'ðŸ“¦ Deploying Backend JARs to Nexus Maven Repository...'
                withCredentials([usernamePassword(credentialsId: "${NEXUS_CREDENTIALS_ID}", usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                    script {
                        def services = [
                            [name: 'discovery-service', enabled: env.BUILD_DISCOVERY],
                            [name: 'gateway-service', enabled: env.BUILD_GATEWAY],
                            [name: 'auth-service', enabled: env.BUILD_AUTH],
                            [name: 'patient-service', enabled: env.BUILD_PATIENT],
                            [name: 'appointment-service', enabled: env.BUILD_APPOINTMENT],
                            [name: 'billing-service', enabled: env.BUILD_BILLING],
                            [name: 'pharmacy-service', enabled: env.BUILD_PHARMACY]
                        ]

                        services.each { service ->
                            if (service.enabled == 'true') {
                                echo "ðŸ“¤ Uploading ${service.name} to Nexus..."
                                sh """
                                    JAR_FILE=\$(find ${service.name}/build/libs -name "*-SNAPSHOT.jar" ! -name "*-plain.jar" | head -1)
                                    if [ -f "\$JAR_FILE" ]; then
                                        echo "Found JAR: \$JAR_FILE"
                                        curl -v -u \$NEXUS_USER:\$NEXUS_PASS \\
                                            --upload-file \$JAR_FILE \\
                                            "${NEXUS_URL}/repository/${NEXUS_SNAPSHOT_REPOSITORY}/com/ihms/${service.name}/${env.BUILD_VERSION}/${service.name}-${env.BUILD_VERSION}.jar" \\
                                            && echo "âœ… ${service.name} uploaded successfully" \\
                                            || echo "âš ï¸ Warning: Could not upload ${service.name}"
                                    else
                                        echo "âš ï¸ JAR not found for ${service.name}"
                                    fi
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Deploy Frontend to Nexus') {
            when {
                allOf {
                    expression { params.DEPLOY_TO_NEXUS == true }
                    expression { env.BUILD_FRONT == 'true' }
                }
            }
            steps {
                echo 'ðŸ“¦ Deploying Frontend to Nexus Repository...'
                withCredentials([usernamePassword(credentialsId: "${NEXUS_CREDENTIALS_ID}", usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                    sh """
                        if [ -f "frontend/ihms-portal-${env.BUILD_VERSION}.tar.gz" ]; then
                            curl -v -u \$NEXUS_USER:\$NEXUS_PASS \\
                                --upload-file frontend/ihms-portal-${env.BUILD_VERSION}.tar.gz \\
                                "${NEXUS_URL}/repository/${NEXUS_SNAPSHOT_REPOSITORY}/com/ihms/ihms-portal/${env.BUILD_VERSION}/ihms-portal-${env.BUILD_VERSION}.tar.gz" \\
                                && echo "âœ… Frontend uploaded successfully" \\
                                || echo "âš ï¸ Warning: Could not upload frontend"
                        else
                            echo "âš ï¸ Frontend tarball not found"
                        fi
                    """
                }
            }
        }

        // ======================== DEPLOY DOCKER IMAGES TO NEXUS ========================

        stage('Build & Push Docker Images to Nexus') {
            when {
                allOf {
                    expression { params.DEPLOY_DOCKER_TO_NEXUS == true }
                    expression {
                        env.BUILD_DISCOVERY == 'true' || env.BUILD_GATEWAY == 'true' ||
                        env.BUILD_AUTH == 'true' || env.BUILD_PATIENT == 'true' ||
                        env.BUILD_APPOINTMENT == 'true' || env.BUILD_BILLING == 'true' ||
                        env.BUILD_PHARMACY == 'true' || env.BUILD_FRONT == 'true'
                    }
                }
            }
            steps {
                echo 'ðŸ³ Building and Pushing Docker Images to Nexus Docker Registry...'
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh "echo \$DOCKER_PASS | docker login ${DOCKER_REGISTRY} -u \$DOCKER_USER --password-stdin || echo 'âš ï¸ Docker login failed - continuing anyway'"

                    script {
                        def services = [
                            [name: 'discovery-service', enabled: env.BUILD_DISCOVERY],
                            [name: 'gateway-service', enabled: env.BUILD_GATEWAY],
                            [name: 'auth-service', enabled: env.BUILD_AUTH],
                            [name: 'patient-service', enabled: env.BUILD_PATIENT],
                            [name: 'appointment-service', enabled: env.BUILD_APPOINTMENT],
                            [name: 'billing-service', enabled: env.BUILD_BILLING],
                            [name: 'pharmacy-service', enabled: env.BUILD_PHARMACY]
                        ]

                        services.each { service ->
                            if (service.enabled == 'true') {
                                echo "ðŸ³ Building and pushing Docker image for ${service.name}..."
                                sh """
                                    docker build -t ${DOCKER_REGISTRY}/ihms/${service.name}:${env.BUILD_VERSION} \\
                                                 -t ${DOCKER_REGISTRY}/ihms/${service.name}:latest \\
                                                 -f ${service.name}/Dockerfile . \\
                                        && echo "âœ… Docker image built for ${service.name}" \\
                                        || echo "âš ï¸ Docker build failed for ${service.name}"

                                    docker push ${DOCKER_REGISTRY}/ihms/${service.name}:${env.BUILD_VERSION} || echo "âš ï¸ Push failed"
                                    docker push ${DOCKER_REGISTRY}/ihms/${service.name}:latest || echo "âš ï¸ Push failed"
                                """
                            }
                        }

                        // Build and push frontend
                        if (env.BUILD_FRONT == 'true') {
                            echo "ðŸ³ Building and pushing Docker image for frontend..."
                            sh """
                                docker build -t ${DOCKER_REGISTRY}/ihms/ihms-portal:${env.BUILD_VERSION} \\
                                             -t ${DOCKER_REGISTRY}/ihms/ihms-portal:latest \\
                                             -f frontend/ihms-portal/Dockerfile . \\
                                    && echo "âœ… Docker image built for frontend" \\
                                    || echo "âš ï¸ Docker build failed for frontend"

                                docker push ${DOCKER_REGISTRY}/ihms/ihms-portal:${env.BUILD_VERSION} || echo "âš ï¸ Push failed"
                                docker push ${DOCKER_REGISTRY}/ihms/ihms-portal:latest || echo "âš ï¸ Push failed"
                            """
                        }
                    }
                }
            }
        }

        // ======================== DEPLOY TO LOCAL DOCKER (Optional) ========================

        stage('Deploy to Local Docker') {
            when { expression { params.DEPLOY_TO_LOCAL_DOCKER == true } }
            steps {
                echo 'ðŸ–¥ï¸ Deploying to Local Docker...'
                script {
                    // Start databases if any backend service is being deployed
                    if (env.BUILD_DISCOVERY == 'true' || env.BUILD_GATEWAY == 'true' ||
                        env.BUILD_AUTH == 'true' || env.BUILD_PATIENT == 'true' ||
                        env.BUILD_APPOINTMENT == 'true' || env.BUILD_BILLING == 'true' ||
                        env.BUILD_PHARMACY == 'true') {

                        sh '''
                            docker-compose -f docker-compose.local.yml up -d auth-db patient-db appointment-db billing-db pharmacy-db || true
                            echo "â³ Waiting for databases..."
                            sleep 15
                        '''
                    }

                    // Deploy selected backend services
                    def backendServices = [
                        [name: 'discovery-service', enabled: env.BUILD_DISCOVERY],
                        [name: 'gateway-service', enabled: env.BUILD_GATEWAY],
                        [name: 'auth-service', enabled: env.BUILD_AUTH],
                        [name: 'patient-service', enabled: env.BUILD_PATIENT],
                        [name: 'appointment-service', enabled: env.BUILD_APPOINTMENT],
                        [name: 'billing-service', enabled: env.BUILD_BILLING],
                        [name: 'pharmacy-service', enabled: env.BUILD_PHARMACY]
                    ]

                    backendServices.each { service ->
                        if (service.enabled == 'true') {
                            sh "docker-compose -f docker-compose.local.yml up -d --no-deps --build ${service.name} || echo 'âš ï¸ Could not start ${service.name}'"
                        }
                    }

                    // Deploy frontend
                    if (env.BUILD_FRONT == 'true') {
                        sh '''
                            docker rm -f ihms-portal 2>/dev/null || true
                            docker-compose -f docker-compose.local.yml build ihms-portal || true
                            docker run -d --name ihms-portal -p 3000:80 --network jenkins_po_source_ihms-network jenkins_po_source_ihms-portal:latest || echo "âš ï¸ Could not start frontend"
                        '''
                    }
                }
            }
        }

        // ======================== VERIFICATION ========================

        stage('Verify Deployment') {
            steps {
                echo 'âœ… Verifying Deployment...'
                sh 'sleep 15'
                script {
                    sh '''
                        echo ""
                        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                        echo "â•‘              DEPLOYMENT VERIFICATION                         â•‘"
                        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                        echo "â•‘ Docker Containers:                                           â•‘"
                        docker ps --format "table {{.Names}}\\t{{.Status}}" | grep -E "ihms|nexus" || echo "No IHMS/Nexus containers"
                        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    '''

                    if (params.DEPLOY_TO_LOCAL_DOCKER) {
                        sh '''
                            echo ""
                            echo "=== Service Health Check ==="
                        '''

                        def healthChecks = [
                            [name: 'Discovery', port: 8761, enabled: env.BUILD_DISCOVERY],
                            [name: 'Gateway', port: 8080, enabled: env.BUILD_GATEWAY],
                            [name: 'Auth', port: 8081, enabled: env.BUILD_AUTH],
                            [name: 'Patient', port: 8082, enabled: env.BUILD_PATIENT],
                            [name: 'Appointment', port: 8083, enabled: env.BUILD_APPOINTMENT],
                            [name: 'Billing', port: 8084, enabled: env.BUILD_BILLING],
                            [name: 'Pharmacy', port: 8085, enabled: env.BUILD_PHARMACY]
                        ]

                        healthChecks.each { check ->
                            if (check.enabled == 'true') {
                                sh "echo -n '${check.name} (${check.port}): ' && curl -s http://localhost:${check.port}/actuator/health 2>/dev/null | grep -o '\"status\":\"[^\"]*\"' || echo 'DOWN'"
                            }
                        }

                        if (env.BUILD_FRONT == 'true') {
                            sh 'echo -n "Frontend (3000): " && curl -s http://localhost:3000 2>/dev/null | head -1 | grep -q html && echo "UP" || echo "DOWN"'
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            âœ… IHMS BUILD & DEPLOYMENT SUCCESSFUL!                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ BUILT SERVICES:                                                          â•‘
â•‘   Discovery: ${env.BUILD_DISCOVERY}  Gateway: ${env.BUILD_GATEWAY}  Auth: ${env.BUILD_AUTH}
â•‘   Patient: ${env.BUILD_PATIENT}  Appointment: ${env.BUILD_APPOINTMENT}
â•‘   Billing: ${env.BUILD_BILLING}  Pharmacy: ${env.BUILD_PHARMACY}  Frontend: ${env.BUILD_FRONT}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ARTIFACTS:                                                               â•‘
â•‘   Version:          ${env.BUILD_VERSION}
â•‘   Nexus Maven:      ${NEXUS_URL}/repository/${NEXUS_SNAPSHOT_REPOSITORY}
â•‘   Nexus Docker:     ${DOCKER_REGISTRY}/ihms/*
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ LOCAL ACCESS (if deployed):                                              â•‘
â•‘   ðŸŒ Frontend:  http://localhost:3000                                    â•‘
â•‘   ðŸ”Œ Gateway:   http://localhost:8080                                    â•‘
â•‘   ðŸ“¡ Eureka:    http://localhost:8761                                    â•‘
â•‘   ðŸ“¦ Nexus:     http://localhost:8081                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo 'âŒ Pipeline failed! Check logs for details.'
        }
        always {
            sh 'docker logout ${DOCKER_REGISTRY} 2>/dev/null || true'
            cleanWs(cleanWhenNotBuilt: false, deleteDirs: true, disableDeferredWipeout: true, notFailBuild: true)
        }
    }
}

